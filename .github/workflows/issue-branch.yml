name: Create branch from Issue comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  create-branch:
    if: startsWith(github.event.comment.body, '/branch')
    runs-on: ubuntu-latest
    steps:
      - name: Create branch
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Skip PR comments
            if (issue.pull_request) {
              core.info('Comment is on a pull request; skipping.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const defaultBranch = context.payload.repository.default_branch;

            const rawTitle = issue.title || '';
            const slug = rawTitle
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .slice(0, 40);

            const branchName = `issue-${issue.number}${slug ? `-${slug}` : ''}`;

            const baseRef = `heads/${defaultBranch}`;
            const base = await github.rest.git.getRef({ owner, repo, ref: baseRef });
            const sha = base.data.object.sha;

            try {
              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/heads/${branchName}`,
                sha,
              });
            } catch (e) {
              // If it already exists, just comment it back
              if (e.status !== 422) throw e;
              core.info(`Branch already exists: ${branchName}`);
            }

            const branchUrl = `https://github.com/${owner}/${repo}/tree/${encodeURIComponent(branchName)}`;
            const body = `ブランチを用意しました: \`${branchName}\`\n\n${branchUrl}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body,
            });
