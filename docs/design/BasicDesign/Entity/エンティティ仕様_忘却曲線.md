# 忘却曲線（間隔反復） - エンティティ仕様

このファイルは `design/UserStory/ユーザーストーリー_忘却曲線.md` のユーザーストーリーを元に、主要エンティティと属性、リレーションを定義します。

## 概要

- 目的: 学習アイテムの管理、復習セッションのスケジューリング（忘却曲線/SRS）、通知、進捗分析、教師向け集計をサポートするためのデータモデル。

---

## エンティティ一覧（概要）

- `User` - ユーザー（学習者／教師）
- `LearningItem` - 学習アイテム（カード、問題）
- `Category` - 学習アイテムのカテゴリ（任意）
- `Tag` - アイテムタグ／カテゴリ
- `ReviewSession` - 復習セッション（ユーザーが行ったセッション）
- `ReviewHistory` - 個別アイテムの復習履歴（判定・スコア）
- `Schedule` - 次回復習予定（冗長キャッシュ用）
- `SrsSetting` - 復習アルゴリズム設定（ユーザー別）
- `NotificationSetting` - 通知の設定
- `ImportJob` - インポート/エクスポート履歴
- `Class` / `Enrollment` - 教師機能でのクラス管理
- `ProgressStats` - 集計キャッシュ（ダッシュボード用）

---

## 各エンティティ詳細

### `User`

- 説明: システム利用者（学習者または教師）
- 属性:
  - `id` (UUID, PK)
  - `email` (string, unique, indexed)
  - `name` (string)
  - `role` (enum: `student`|`teacher`|`admin`)
  - `timezone` (string, optional)
  - `createdAt` (datetime)
  - `updatedAt` (datetime)
- リレーション:
  - `learningItems` (1:N -> `LearningItem.ownerId`)
  - `srsSetting` (1:1 -> `SrsSetting.userId`)
  - `notificationSetting` (1:1 -> `NotificationSetting.userId`)
  - `enrollments` (1:N -> `Enrollment.userId`)

### `LearningItem`

- 説明: 復習対象の単位（フラッシュカード、問題など）
- 属性:
  - `id` (UUID, PK)
  - `ownerId` (UUID -> `User.id`) - 所有者
  - `categoryId` (UUID -> `Category.id`, optional)
  - `title` (string)
  - `content` (text / JSON) - 問題文や解答等
  - `type` (enum: `card`|`qa`|`cloze`)
  - `difficulty` (int, optional) - ユーザーが設定する難易度
  - `createdAt`, `updatedAt`
- リレーション:
  - `category` (N:1 -> `Category`)
  - `tags` (N:N -> `Tag` via `LearningItemTag`)
  - `histories` (1:N -> `ReviewHistory.itemId`)
  - `nextSchedule` (1:1 -> `Schedule.itemId`)

### `Category`

- 説明: 学習アイテムの「単一カテゴリ」分類（任意）。UIの「カテゴリーフィルタ」用途を想定。
- 属性:
  - `id` (UUID, PK)
  - `name` (string, unique)
  - `ownerId` (UUID -> `User.id`, optional) - ユーザー固有カテゴリを許容する場合
  - `createdAt` (datetime)
  - `updatedAt` (datetime)
- リレーション:
  - `items` (1:N -> `LearningItem.categoryId`)

### `Tag`

- 説明: アイテムのタグ（カテゴリ）
- 属性: `id`, `name`, `ownerId` (ユーザー固有のタグ可), `createdAt`

**補足（`tags` の目的と運用）**

- 目的: 学習アイテムをカテゴリ／トピックで分類し、フィルタ・優先度付け・推奨の基礎データとする。
- スコープ: タグはグローバル共有（公開タグ）またはユーザー固有の両方を許容する。`ownerId` が null の場合は共有タグと扱う。
- 実装メモ: 多対多は中間テーブル `LearningItemTag(itemId, tagId)` で実装。表示順や重要度が必要なら中間テーブルに `weight` を持たせる。
- UI/UX: 検索・フィルタ画面で複数タグの AND/OR 指定をサポートすると利便性が高い。

### `ReviewSession`

- 説明: ユーザーが開始した復習単位（1回のセッション）
- 属性:
  - `id` (UUID)
  - `userId` (UUID)
  - `startedAt` (datetime)
  - `endedAt` (datetime, optional)
  - `itemsCount` (int)
  - `correctCount` (int)
  - `metadata` (JSON, 任意の環境情報)
- リレーション:
  - `histories` (1:N -> `ReviewHistory.sessionId`)

### `ReviewHistory`

- 説明: 1アイテムに対する1回の復習結果（SRS評価や正誤）
- 属性:
  - `id` (UUID)
  - `itemId` (UUID -> `LearningItem.id`)
  - `userId` (UUID)
  - `sessionId` (UUID -> `ReviewSession.id`, optional)
  - `result` (enum: `correct`|`incorrect`|`partial`)
  - `quality` (int 0-5) - SM-2スタイルの入力値
  - `efactor` (float) - オプション、アルゴリズムの内部値
  - `intervalDays` (int) - 計算された次回間隔（日）
  - `nextReviewAt` (datetime) - 計算結果の次回日時
  - `responseTimeMs` (int, optional)
  - `createdAt` (datetime)

**補足（`histories` の用途と保持方針）**

- 用途: `ReviewHistory` は「いつ」「誰が」「どのように」復習したかのイベントログを保持する。単なる最新スケジュールではなく、監査・統計・アルゴリズムの学習用データとして重要。
- 保持方針: 追加（append-only）を基本とし、誤差訂正や再送処理に備えて作成時は冪等性キー（例: sessionId+itemId+timestamp）を使用する。
- 集計: 生データは肥大化しやすいため、日次バッチで `ProgressStats` や集計テーブルに転写し、古い履歴はアーカイブ（圧縮保存）する運用を推奨。
- 参照: 次回復習日時のソースは原則 `ReviewHistory.nextReviewAt`（直近の履歴）だが、パフォーマンス上は `Schedule` を参照する方が良い。

### `Schedule` (冗長キャッシュ)

- 説明: クエリ性能向上のため、各アイテムの次回復習日を保持
- 属性: `itemId` (PK, -> `LearningItem.id`), `userId`, `nextReviewAt`, `priority`, `updatedAt`

**補足（`nextSchedule` / `Schedule` の目的と更新ルール）**

- 目的: 毎日のスケジューラや通知配信で効率的に「今日復習すべきアイテム」を抽出するためのキャッシュ。生履歴検索を避けることで大量ユーザー時のクエリ負荷を抑える。
- 更新タイミング: ユーザーがアイテムをレビューして `ReviewHistory` を追加したタイミングで、トランザクション内または確実な非同期処理フローで `Schedule.nextReviewAt` を更新する（整合性を担保するため、更新は最終的に `ReviewHistory` の最新エントリに基づく）。
- 欄分: `ReviewHistory.nextReviewAt` はアルゴリズムの出力（ソースデータ）で、`Schedule.nextReviewAt` はそのキャッシュ。両者が乖離した場合は `ReviewHistory` 側が真のソース。
- 優先度: `priority` は短期的な再学習や手動調整を反映する補助値。スケジューラは `(nextReviewAt, priority)` の順でソートして提示する。
- 再同期処理: バッチで `ReviewHistory` から `Schedule` を再生成するジョブを用意し、万が一の乖離検出時に復旧できるようにする。

### `SrsSetting`

- 説明: 復習アルゴリズム（SRS）のユーザー別パラメータ。ユーザーストーリーの「難易度感度や間隔基準などの設定UI」に対応。
- 属性:
  - `userId` (UUID, PK, -> `User.id`)
  - `algorithm` (enum: `sm2` など)
  - `difficultySensitivity` (float) - 難易度や評価の影響度（UIで調整）
  - `intervalMultiplier` (float) - 間隔の倍率（UIで調整）
  - `minIntervalDays` (int)
  - `maxIntervalDays` (int)
  - `createdAt` (datetime)
  - `updatedAt` (datetime)
- リレーション:
  - `user` (1:1 -> `User`)

**補足（プレビュー）**

- 設定変更時の「プレビュー」は、DBに別エンティティを持たずに「設定 + 少数サンプルアイテム」を入力としてサーバ側で試算し、結果を返す形を想定します。

### `NotificationSetting`

- 説明: ユーザーの通知設定
- 属性: `userId` (PK), `enabled` (bool), `channels` (JSON: `email`, `push` 等), `timeWindow` (string / cron-like), `createdAt`

### `ImportJob`

- 説明: CSV/JSONインポート/エクスポートの履歴と状態
- 属性: `id`, `userId`, `type` (enum: `import`|`export`), `status` (enum), `fileUrl`(optional), `mapping`(JSON), `createdAt`, `finishedAt`, `errors`(JSON)

### `Class` / `Enrollment`

- `Class`: `id`, `teacherId`, `name`, `description`, `createdAt`
- `Enrollment`: `id`, `classId`, `userId`, `role` (student/assistant), `joinedAt`

### `ProgressStats` (集計キャッシュ)

- 説明: ダッシュボード用に集計したデータを保持
- 属性: `userId`, `periodStart`, `periodEnd`, `correctRate`, `studyMinutes`, `streakDays`, `updatedAt`

---

## インデックスとパフォーマンス上の注意

- `ReviewHistory(nextReviewAt)` にインデックスを貼り、当日の対象アイテム抽出を高速化。
- `Schedule(nextReviewAt, priority)` の複合インデックスでスケジューラが効率化。
- 古い `ReviewHistory` は定期的に集計→`ProgressStats` に転写してアーカイブすることでテーブル肥大化を抑制。

---

## サンプル JSON（学習アイテム + 履歴）

{
  "learningItem": {
    "id": "uuid-item-1",
    "ownerId": "uuid-user-1",
    "title": "TODOリストとは",
    "content": {"front":"TODOとは?","back":"やるべきことの一覧"},
    "type": "card"
  },
  "reviewHistory": {
    "id": "uuid-history-1",
    "itemId": "uuid-item-1",
    "userId": "uuid-user-1",
    "result": "correct",
    "quality": 5,
    "intervalDays": 7,
    "nextReviewAt": "2026-02-18T09:00:00Z"
  }
}

---

## マイグレーション / API 設計へのヒント

- 各エンティティは REST/GraphQL 両対応を想定し、IDは UUID を推奨。
- SRS アルゴリズムの内部値（`efactor` 等）は `ReviewHistory` に保存し、再計算可能にする。
- 教師ダッシュボード向け集計はバッチ処理（夜間）で `ProgressStats` を更新。

---
