# DOMAIN.md

## 認証

### スコープ（MVP）

- 認証方式は **メール+パスワード** とする。
- MVPでは **サインアップ（新規登録）を必須にしない**。
  - ユーザーは seed / 管理者投入などで事前作成し、ログインのみ提供してよい。
- MFA、メール認証、パスワードリセットはMVPでは非対象（必要になった時点で追加する）。

### 用語

- Access Token
  - APIアクセスに使う短命トークン（JWT）。
- Refresh Token
  - Access Token を再発行するための長命トークン。
  - 失効/ローテーション管理のため、サーバ側DBで管理する。

### ユーザー（認証主体）

- ユーザーは一意な `email` を持つ。
- `email` は正規化して比較する。
  - 前後空白除去、`lowercase` を基本とする（表示用は別フィールドに分けてもよい）。
- アカウント状態を持てるようにする（MVPでも将来拡張のために概念を用意する）。
  - 例: `isActive`（無効化されたユーザーはログイン不可）

### パスワード

- 平文パスワードは保存しない。
- ハッシュは **argon2id**（argon2）を使用する。
  - パラメータ（メモリ/時間/並列）は環境変数等で調整可能にする。
- MVPの強度要件は「最低限」に留めてもよいが、BE側で必須チェックは行う。
  - 例: 最小文字数、空文字不可

### ログイン（認証）ルール

- ログイン入力
  - `email` と `password` を受け取る。
  - バリデーション不備は `400`（`VALIDATION_ERROR`）。
- 認証失敗
  - `email` の存在有無を推測されないよう、返却は原則 `401` + 汎用メッセージにする。
  - 例: `"メールアドレスまたはパスワードが違います"`
- ログイン成功
  - Access/Refresh の Cookie を発行する。

### トークン/セッション運用ルール

- Cookie は最低限以下の2つを想定する。
  - `access_token`（短命JWT）
  - `refresh_token`（長命。再発行用）
- 有効期限（目安）
  - `access_token`: 10〜30分
  - `refresh_token`: 7〜30日
  - 有効期限は、DBにあるマスター設定テーブルの設定値にて変更可能とする。
- Refresh Token の保管
  - DBに保存し、失効管理できるようにする。
  - DBには **平文を保存せずハッシュ** を保存する（漏洩時の被害を抑える）。
  - 端末識別が必要になったら `userAgent`/`ip`/`deviceName` 等を付与する（MVPでは必須にしない）。

### Refresh のローテーション

- `POST /api/auth/refresh` で Access を再発行する。
- Refresh Token は **ローテーション推奨**（毎回新しい refresh を発行し、古いものを失効）。
  - リプレイ攻撃の検知/被害縮小に有効。
- refresh の使い回し（失効済みrefreshの再利用）を検知したら、当該ユーザーのセッションを広めに失効する運用も検討する。

### ログアウト

- `POST /api/auth/logout` で refresh を失効し、Cookie を削除する。
- Cookie削除は `Set-Cookie` の `Max-Age=0`（または期限過去）で行う。

### 認可（Authorization）

- MVPでは「ログイン必須/不要」の区別のみでもよい。
- ユーザー別データを扱う場合は、必ず `userId` をサーバ側の認証情報から取得し、
  クライアント送信の `userId` を信用しない。

### セキュリティ要件

- Cookie 属性
  - `httpOnly: true`
  - `secure: true`（本番）
  - `sameSite: 'lax'`（同一オリジン運用を基本）
  - `path: '/'`
- CSRF
  - 同一オリジン運用 + `SameSite=Lax` を基本とする。
  - 別ドメイン配信（`SameSite=None`）に移行する場合は、CSRFトークン等の追加対策を必須とする。
- レート制限
  - ログインはブルートフォース対策として、IP単位の簡易レート制限を入れる（MVPでも推奨）。
- 情報漏洩防止
  - パスワード/トークン/セッション識別子をログに出さない。
  - `401` の理由を詳細に返しすぎない（アカウント列挙対策）。

### 監査/ログ（最低限）

- 記録対象（目安）
  - ログイン成功/失敗（失敗は回数・IP・requestId を必ず）
  - refresh 成功/失敗
  - logout
- ログには `requestId` を含め、追跡可能にする。
